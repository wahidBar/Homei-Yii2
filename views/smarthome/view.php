<?php

/**
 * Autogenerated From GII
 * modified by Defri Indra M
 * 2021
 */

use richardfan\widget\JSRegister;
use yii\helpers\Html;
use yii\helpers\Url;

/**
 * @var yii\web\View $this
 * @var yii\data\ActiveDataProvider $dataProvider
 * @var app\models\search\SmarthomeSearch $searchModel
 */

$this->title = $model->nama;
$this->params['breadcrumbs'][] = $this->title;

?>
<style>
    .iconize {
        background-color: #efefef;
        display: inline-block;
        padding: .2rem .8rem;
        border-radius: 100%;
        align-self: center;
        width: 4rem;
        height: 4rem;
        display: flex;
        align-items: center;
        text-align: center;
        justify-content: center;
    }
</style>
<?= Html::a('Kembali', ['index'], ['class' => 'btn btn-default mb-2']) ?>

<div class="row">
    <div class="col-lg-12 col-md-12 col-md-4 mb-2">
        <div class="row">
            <?= $this->render("partials/box.php", [
                'id' => 'daya',
                "title" => "Daya",
                'value' => $model->daya,
                "unit" => "W",
                "icon" => "fa-bolt",
                "previous" => $model->daya_sebelumnya,
                "iconClass" => "text-warning",
            ]) ?>
            <?= $this->render("partials/box.php", [
                'id' => 'arus',
                "title" => "Arus",
                'value' => $model->ampere,
                "unit" => "A",
                "icon" => "fa-tachometer",
                "previous" => $model->ampere_sebelumnya,
                "iconClass" => "text-warning",
            ]) ?>
        </div>
    </div>

    <?php if($sirkuit) : ?>
    <div class="col-lg-12 mb-2">
        <div class="card card-default">
            <div class="card-header">
                <strong>
                    <span id="namasirkuit">
                        <?= ucwords($sirkuit['nama']) ?>
                    </span>
                </strong>
                <div class="pull-right">
                    <select class="form-control" name="" id="selectedsirkuit">
                        <option value="">-- Pilih --</option>
                        <?php foreach ($dropdown as $item) : ?>
                            <option value="<?= $item['id'] ?>" <?= ($_GET['sirkuit_id'] == $item['id']) ? 'selected' : '' ?>><?= $item['nama'] ?></option>
                        <?php endforeach ?>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="row">

                    <div class="col-lg-12 mb-2">
                        <div class="row">
                            <div class="col-lg-6 col-md-12 mb-2">
                                <?= $this->render('_chart', [
                                    'graph' => $graphdaya,
                                    'id' => 'chartdaya',
                                    'unit' => 'W',
                                    'title' => 'Grafik Daya'
                                ]) ?>
                            </div>
                            <div class="col-lg-6 col-md-12 mb-2">
                                <?= $this->render('_chart', [
                                    'graph' => $graphampere,
                                    'id' => 'chartampere',
                                    'unit' => 'A',
                                    'title' => 'Grafik Arus'
                                ]) ?>
                            </div>
                        </div>
                    </div>
                    <?php foreach ($sirkuit['data'] as $index_item => $value) : ?>
                        <div class="col-lg-4 col-md-4 mb-2">
                            <div class="card card-default">
                                <div class="card-header">
                                    <?= ucwords($index_item) ?>
                                </div>
                                <div class="card-body">
                                    <?= $this->render('partials/tachometer.php', [
                                        'id' => "sirkuit" . $index . $index_item,
                                        'value' => $value,
                                        'max' => $sirkuit['max'][$index_item],
                                        'unit' => $sirkuit['unit'][$index_item],
                                        'color' => $sirkuit['color'][$index_item],
                                    ]) ?>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
    </div>
    <?php endif ?>

    <div class="col-lg-12 mb-2">
        <div class="card card-default">
            <div class="card-header">
                <strong>
                    Daftar Kontroler
                </strong>
            </div>
            <div class="card-body">
                <?= $this->render('_tab-kontrol', ['model' => $model, 'withValue' => true]) ?>
            </div>
        </div>
    </div>
</div>

<?php JSRegister::begin() ?>
<script>
    $(document).ready(function() {
        // auto refresh
        setInterval(function() {
            $.ajax({
                url: "<?= Url::to(['smarthome/autorefresh', 'id' => $model->id]) ?>",
                type: "GET",
                data: {
                    id: <?= $model->id ?>,
                    sirkuit_id: $("#selectedsirkuit").val()
                },
                success: function(response) {
                    if (response.success) {
                        response = response.data;

                        let daya = parseFloat(response.daya);
                        let arus = parseFloat(response.arus);
                        let daya_sebelumnya = parseFloat(response.daya_sebelumnya);
                        let arus_sebelumnya = parseFloat(response.arus_sebelumnya);

                        $("#valueboxdaya").html(daya);
                        $("#valueboxarus").html(arus);

                        if (daya == daya_sebelumnya) {
                            $("#statusboxdaya").attr("class", "fa fa-balance-scale text-secondary");
                        } else {
                            if (daya > daya_sebelumnya) {
                                $("#statusboxdaya").attr("class", "fa fa-arrow-up text-success");
                            } else {
                                $("#statusboxdaya").attr("class", "fa fa-arrow-down text-danger");
                            }
                        }

                        if (arus == arus_sebelumnya) {
                            $("#statusboxarus").attr("class", "fa fa-balance-scale text-secondary");
                        } else {
                            if (arus > arus_sebelumnya) {
                                $("#statusboxarus").attr("class", "fa fa-arrow-up text-success");
                            } else {
                                $("#statusboxarus").attr("class", "fa fa-arrow-down text-danger");
                            }
                        }

                        chartchartdaya.updateSeries(response.graphdaya.series);
                        chartchartampere.updateSeries(response.graphampere.series);


                        chartchartdaya.updateOptions({
                            xaxis: {
                                categories: response.graphdaya.categories
                            },
                            series: response.graphdaya.series
                        });

                        chartchartampere.updateOptions({
                            xaxis: {
                                categories: response.graphampere.categories
                            },
                            series: response.graphampere.series
                        });


                        // let sirkuit = Object.entries(response.sirkuit)
                        // for (let i = 0; i < sirkuit.length; i++) {
                        //     let item = sirkuit[i];
                        let sirkuit = response.sirkuit;
                        $('#namasirkuit').text(sirkuit.nama);
                        let data = sirkuit.data;
                        let id = '<?= "sirkuit" . $index . $index_item ?>';
                        for (let j in data) {
                            let valueInPercent = (parseInt(data[j]) / parseInt(sirkuit.max[j]) * 100);
                            let label = Math.round(data[j]) + ' / ' + Math.round(sirkuit.max[j]) + ' ' + sirkuit.unit[j];
                            let query = `tachometer${id}.updateOptions({
                                    series: [${valueInPercent}],
                                    labels: ['${label}']
                                });`;
                            eval(query)
                        }
                        // }
                    }
                }
            });
        }, 5000);
    });
</script>
<?php JSRegister::end() ?>